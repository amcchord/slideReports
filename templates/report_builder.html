{% extends "base.html" %}

{% block title %}Build Report - Slide Reports{% endblock %}

{% block content %}
<div style="margin-top: 2rem;">
    <h1>Build Report</h1>
    
    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-gear"></i> Report Configuration
        </div>
        <div class="card-body">
            <form id="report-form">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="template-select" class="form-label">Template</label>
                        <select class="form-select" id="template-select" required>
                            {% for template in templates %}
                            <option value="{{ template.template_id }}" {% if template.is_default %}selected{% endif %}>
                                {{ template.name }}{% if template.is_default %} (Default){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="client-select" class="form-label">Client Filter</label>
                        <select class="form-select" id="client-select">
                            <option value="">All Clients</option>
                            {% for client in clients %}
                            <option value="{{ client.client_id }}">{{ client.name or client.client_id }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="start-date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="start-date" required>
                    </div>
                    <div class="col-md-2">
                        <label for="end-date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end-date" required>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Quick Date Selection</label>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setThisWeek()">This Week</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setLastWeek()">Last Week</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setThisMonth()">This Month</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setLastMonth()">Last Month</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setThisQuarter()">This Quarter</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setLastQuarter()">Last Quarter</button>
                    </div>
                    <div id="date-range-hint" class="form-text mt-2" style="display: none;"></div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Data Sources to Include</label>
                    <div class="data-sources-grid">
                        {% set icon_map = {
                            'devices': 'bi-hdd',
                            'agents': 'bi-cpu',
                            'backups': 'bi-arrow-repeat',
                            'snapshots': 'bi-camera',
                            'alerts': 'bi-exclamation-triangle',
                            'audits': 'bi-file-earmark-text',
                            'clients': 'bi-building',
                            'users': 'bi-people',
                            'networks': 'bi-diagram-3',
                            'virtual_machines': 'bi-box',
                            'file_restores': 'bi-folder-symlink',
                            'image_exports': 'bi-file-earmark-image',
                            'accounts': 'bi-person-badge'
                        } %}
                        {% for source in data_sources %}
                        <label class="source-toggle-card" for="source-{{ source.key }}">
                            <div class="source-icon">
                                <i class="bi {{ icon_map.get(source.key, 'bi-box') }}"></i>
                            </div>
                            <div class="source-info">
                                <div class="source-name">{{ source.name }}</div>
                                <div class="source-count">{{ source.count }} items</div>
                            </div>
                            <div class="custom-toggle-switch">
                                <input type="checkbox" value="{{ source.key }}" id="source-{{ source.key }}" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" id="preview-button" onclick="previewReport()">
                        <i class="bi bi-eye"></i> Preview Report
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="card" id="preview-card" style="display: none;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-file-earmark-text"></i> Report Preview</span>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-success" onclick="downloadReportHTML()">
                    <i class="bi bi-download"></i> Download HTML
                </button>
                <button class="btn btn-sm btn-primary" onclick="printReport()">
                    <i class="bi bi-printer"></i> Print / Save as PDF
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <iframe id="report-preview" style="width: 100%; min-height: 800px; border: none;"></iframe>
        </div>
    </div>
</div>

<script>
// Template metadata for date range validation
const templateMetadata = {
    {% for template in templates %}
    '{{ template.template_id }}': {
        name: '{{ template.name }}',
        type: {% if 'Weekly' in template.name %}'weekly'{% elif 'Monthly' in template.name %}'monthly'{% elif 'Quarterly' in template.name %}'quarterly'{% else %}'custom'{% endif %}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

// Set default date range (last 7 days for weekly by default)
window.addEventListener('DOMContentLoaded', () => {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 7);
    
    document.getElementById('end-date').valueAsDate = endDate;
    document.getElementById('start-date').valueAsDate = startDate;
    
    // Pre-select template from URL if provided
    const urlParams = new URLSearchParams(window.location.search);
    const templateId = urlParams.get('template_id');
    if (templateId) {
        document.getElementById('template-select').value = templateId;
    }
    
    // Add template change listener
    document.getElementById('template-select').addEventListener('change', updateDateRangeHint);
    updateDateRangeHint();
});

function getSelectedDataSources() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function updateDateRangeHint() {
    const templateId = document.getElementById('template-select').value;
    const metadata = templateMetadata[templateId];
    const hintElement = document.getElementById('date-range-hint');
    
    if (!metadata) return;
    
    if (metadata.type === 'weekly') {
        hintElement.textContent = 'Recommended: Select exactly 7 consecutive days (one week)';
        hintElement.className = 'form-text mt-2 text-info';
        hintElement.style.display = 'block';
    } else if (metadata.type === 'monthly') {
        hintElement.textContent = 'Recommended: Select a full calendar month (first day to last day)';
        hintElement.className = 'form-text mt-2 text-info';
        hintElement.style.display = 'block';
    } else if (metadata.type === 'quarterly') {
        hintElement.textContent = 'Recommended: Select exactly 13 weeks (91-92 days) or 3 full months';
        hintElement.className = 'form-text mt-2 text-info';
        hintElement.style.display = 'block';
    } else {
        hintElement.style.display = 'none';
    }
}

function setThisWeek() {
    const today = new Date();
    const dayOfWeek = today.getDay();
    const startDate = new Date(today);
    startDate.setDate(today.getDate() - dayOfWeek);
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 6);
    
    document.getElementById('start-date').valueAsDate = startDate;
    document.getElementById('end-date').valueAsDate = endDate;
}

function setLastWeek() {
    const today = new Date();
    const dayOfWeek = today.getDay();
    const startDate = new Date(today);
    startDate.setDate(today.getDate() - dayOfWeek - 7);
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 6);
    
    document.getElementById('start-date').valueAsDate = startDate;
    document.getElementById('end-date').valueAsDate = endDate;
}

function setThisMonth() {
    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
    const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    document.getElementById('start-date').valueAsDate = startDate;
    document.getElementById('end-date').valueAsDate = endDate;
}

function setLastMonth() {
    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const endDate = new Date(today.getFullYear(), today.getMonth(), 0);
    
    document.getElementById('start-date').valueAsDate = startDate;
    document.getElementById('end-date').valueAsDate = endDate;
}

function setThisQuarter() {
    const today = new Date();
    const quarter = Math.floor(today.getMonth() / 3);
    const startDate = new Date(today.getFullYear(), quarter * 3, 1);
    const endDate = new Date(today.getFullYear(), quarter * 3 + 3, 0);
    
    document.getElementById('start-date').valueAsDate = startDate;
    document.getElementById('end-date').valueAsDate = endDate;
}

function setLastQuarter() {
    const today = new Date();
    const quarter = Math.floor(today.getMonth() / 3) - 1;
    const year = quarter < 0 ? today.getFullYear() - 1 : today.getFullYear();
    const adjustedQuarter = quarter < 0 ? 3 : quarter;
    const startDate = new Date(year, adjustedQuarter * 3, 1);
    const endDate = new Date(year, adjustedQuarter * 3 + 3, 0);
    
    document.getElementById('start-date').valueAsDate = startDate;
    document.getElementById('end-date').valueAsDate = endDate;
}

function validateDateRange() {
    const templateId = document.getElementById('template-select').value;
    const metadata = templateMetadata[templateId];
    const startDate = new Date(document.getElementById('start-date').value);
    const endDate = new Date(document.getElementById('end-date').value);
    
    if (!metadata || metadata.type === 'custom') {
        return { valid: true };
    }
    
    const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    
    if (metadata.type === 'weekly') {
        if (daysDiff !== 7) {
            return {
                valid: false,
                message: 'Weekly reports require exactly 7 consecutive days. Current selection: ' + daysDiff + ' days.'
            };
        }
    } else if (metadata.type === 'monthly') {
        const isFirstDay = startDate.getDate() === 1;
        const isLastDay = endDate.getDate() === new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0).getDate();
        const sameMonth = startDate.getMonth() === endDate.getMonth() && startDate.getFullYear() === endDate.getFullYear();
        
        if (!isFirstDay || !isLastDay || !sameMonth) {
            return {
                valid: false,
                message: 'Monthly reports require a full calendar month (first day to last day of the same month).'
            };
        }
    } else if (metadata.type === 'quarterly') {
        if (daysDiff < 89 || daysDiff > 92) {
            return {
                valid: false,
                message: 'Quarterly reports require approximately 13 weeks (89-92 days). Current selection: ' + daysDiff + ' days.'
            };
        }
    }
    
    return { valid: true };
}

async function previewReport() {
    const templateId = document.getElementById('template-select').value;
    const clientId = document.getElementById('client-select').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    const dataSources = getSelectedDataSources();
    
    if (!templateId || !startDate || !endDate) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (dataSources.length === 0) {
        alert('Please select at least one data source');
        return;
    }
    
    await window.slideReports.reportManager.previewReport(
        templateId,
        startDate,
        endDate,
        dataSources,
        clientId
    );
    
    // Show preview card
    document.getElementById('preview-card').style.display = 'block';
    document.getElementById('preview-card').scrollIntoView({ behavior: 'smooth' });
}

function printReport() {
    window.slideReports.reportManager.printReport();
}

async function downloadReportHTML() {
    const templateId = document.getElementById('template-select').value;
    const clientId = document.getElementById('client-select').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    const dataSources = getSelectedDataSources();
    
    if (!templateId || !startDate || !endDate) {
        alert('Please ensure all required fields are filled');
        return;
    }
    
    if (dataSources.length === 0) {
        alert('Please select at least one data source');
        return;
    }
    
    // Find the download button and show loading state
    const buttons = document.querySelectorAll('button');
    let downloadButton = null;
    for (const btn of buttons) {
        if (btn.textContent.includes('Download HTML')) {
            downloadButton = btn;
            break;
        }
    }
    
    if (downloadButton) {
        downloadButton.disabled = true;
        downloadButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
    }
    
    try {
        const response = await fetch('/api/reports/download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                template_id: parseInt(templateId),
                start_date: startDate,
                end_date: endDate,
                data_sources: dataSources,
                client_id: clientId || null
            })
        });
        
        if (!response.ok) {
            throw new Error('Download failed');
        }
        
        // Get filename from Content-Disposition header
        const disposition = response.headers.get('Content-Disposition');
        let filename = 'backup-report.html';
        if (disposition && disposition.includes('filename=')) {
            const matches = disposition.match(/filename="(.+)"/);
            if (matches && matches[1]) {
                filename = matches[1];
            }
        }
        
        // Get the HTML content
        const blob = await response.blob();
        
        // Create download link and trigger
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        window.slideReports.utils.showToast('Report downloaded successfully', 'success');
    } catch (error) {
        console.error('Download error:', error);
        alert('Failed to download report: ' + error.message);
    } finally {
        // Restore button state
        if (downloadButton) {
            downloadButton.disabled = false;
            downloadButton.innerHTML = '<i class="bi bi-download"></i> Download HTML';
        }
    }
}
</script>
{% endblock %}

