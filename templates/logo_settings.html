{% extends "base.html" %}

{% block title %}Logo Settings - Slide Reports{% endblock %}

{% block content %}
<div style="margin-top: 2rem;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Logo Settings</h1>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
    
    <div class="row">
        <!-- Upload Section -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-upload"></i> Upload Your Logo
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Upload a custom logo to replace the default Slide logo in the navigation bar and all generated reports.
                    </p>
                    
                    <!-- Drag and Drop Zone -->
                    <div id="drop-zone" class="drop-zone">
                        <i class="bi bi-cloud-upload" style="font-size: 48px; color: #6c757d;"></i>
                        <p class="mb-2"><strong>Drag and drop your logo here</strong></p>
                        <p class="text-muted small mb-3">or</p>
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('logo-file-input').click()">
                            <i class="bi bi-folder2-open"></i> Choose File
                        </button>
                        <input type="file" id="logo-file-input" accept="image/png,image/jpeg,image/gif,image/svg+xml" style="display: none;">
                        <p class="text-muted small mt-3 mb-0">
                            <strong>Requirements:</strong><br>
                            Format: PNG, JPG, GIF, or SVG<br>
                            Max size: 2MB<br>
                            Recommended: Transparent PNG with 150-300px width
                        </p>
                    </div>
                    
                    <!-- Upload Progress -->
                    <div id="upload-progress" style="display: none;" class="mt-3">
                        <div class="progress">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p class="text-center small text-muted mt-2" id="upload-status">Uploading...</p>
                    </div>
                    
                    <!-- Error Display -->
                    <div id="upload-error" class="alert alert-danger mt-3" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i> <span id="error-message"></span>
                    </div>
                    
                    <!-- Success Display -->
                    <div id="upload-success" class="alert alert-success mt-3" style="display: none;">
                        <i class="bi bi-check-circle"></i> Logo uploaded successfully!
                    </div>
                </div>
            </div>
            
            <!-- Current Logo Preview -->
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-eye"></i> Current Logo
                </div>
                <div class="card-body text-center">
                    <div id="current-logo-preview" style="padding: 20px; background: #f8f9fa; border-radius: 8px; min-height: 100px; display: flex; align-items: center; justify-content: center;">
                        {% if custom_logo %}
                        <img src="{{ custom_logo }}" alt="Current Logo" style="max-width: 100%; max-height: 150px; height: auto;">
                        {% else %}
                        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Default Logo" style="max-width: 100%; max-height: 150px; height: auto;">
                        {% endif %}
                    </div>
                    <button id="reset-logo-btn" class="btn btn-outline-danger mt-3" onclick="resetLogo()" {% if not custom_logo %}disabled{% endif %}>
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Default Logo
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Preview Section -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-file-earmark-text"></i> Report Preview
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Preview of how your logo will appear on the Weekly report template.
                    </p>
                    
                    <div id="report-preview" style="border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; background: white; overflow: auto;">
                        <!-- Simulated Report Header -->
                        <div style="border-bottom: 3px solid #3b82f6; padding-bottom: 20px; margin-bottom: 20px; display: flex; align-items: flex-start; gap: 20px;">
                            <img id="preview-logo" src="{% if custom_logo %}{{ custom_logo }}{% else %}{{ url_for('static', filename='img/logo.png') }}{% endif %}" 
                                 alt="Logo" style="max-width: 150px; height: auto; flex-shrink: 0;">
                            <div style="flex: 1;">
                                <h3 style="font-size: 24px; font-weight: 700; color: #1f2937; margin: 0 0 8px 0;">Weekly Backup Report</h3>
                                <div style="color: #6b7280; font-size: 14px;">
                                    <strong>Report Period:</strong> Oct 11 - Oct 18, 2025<br>
                                    <strong>Generated:</strong> Oct 18, 2025 at 2:30 PM EDT
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sample Content -->
                        <div style="margin-bottom: 20px;">
                            <h4 style="font-size: 18px; font-weight: 600; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; margin-bottom: 15px;">
                                Executive Summary
                            </h4>
                            <p style="color: #4b5563; font-size: 14px; line-height: 1.6;">
                                During this reporting period, 148 backups were executed with a 95.3% success rate. 
                                All critical systems are protected and recent snapshots are available.
                            </p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 6px; padding: 15px;">
                                <div style="font-size: 12px; color: #1e40af; font-weight: 600; margin-bottom: 5px;">TOTAL BACKUPS</div>
                                <div style="font-size: 28px; font-weight: 700; color: #1e3a8a;">148</div>
                            </div>
                            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px; padding: 15px;">
                                <div style="font-size: 12px; color: #15803d; font-weight: 600; margin-bottom: 5px;">SUCCESS RATE</div>
                                <div style="font-size: 28px; font-weight: 700; color: #166534;">95.3%</div>
                            </div>
                        </div>
                    </div>
                    
                    <p class="text-muted small mt-3 mb-0">
                        <i class="bi bi-info-circle"></i> This is a simplified preview. Your actual reports will include all selected data and metrics.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.drop-zone {
    border: 2px dashed #cbd5e1;
    border-radius: 12px;
    padding: 40px 20px;
    text-align: center;
    background: #f8fafc;
    transition: all 0.3s ease;
    cursor: pointer;
}

.drop-zone:hover {
    border-color: #3b82f6;
    background: #eff6ff;
}

.drop-zone.drag-over {
    border-color: #3b82f6;
    background: #dbeafe;
    transform: scale(1.02);
}

.drop-zone.uploading {
    opacity: 0.6;
    pointer-events: none;
}
</style>

{% endblock %}

{% block extra_js %}
<script>
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('logo-file-input');
const uploadProgress = document.getElementById('upload-progress');
const uploadError = document.getElementById('upload-error');
const uploadSuccess = document.getElementById('upload-success');
const errorMessage = document.getElementById('error-message');
const progressBar = document.getElementById('progress-bar');
const uploadStatus = document.getElementById('upload-status');
const currentLogoPreview = document.getElementById('current-logo-preview');
const previewLogo = document.getElementById('preview-logo');
const resetLogoBtn = document.getElementById('reset-logo-btn');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight drop zone when item is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight() {
    dropZone.classList.add('drag-over');
}

function unhighlight() {
    dropZone.classList.remove('drag-over');
}

// Handle dropped files
dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
}

// Handle file input change
fileInput.addEventListener('change', function() {
    handleFiles(this.files);
});

// Make drop zone clickable
dropZone.addEventListener('click', function() {
    fileInput.click();
});

function handleFiles(files) {
    if (files.length === 0) {
        return;
    }
    
    const file = files[0];
    
    // Validate file type
    const allowedTypes = ['image/png', 'image/jpeg', 'image/gif', 'image/svg+xml'];
    if (!allowedTypes.includes(file.type)) {
        showError('Invalid file type. Please upload PNG, JPG, GIF, or SVG.');
        return;
    }
    
    // Validate file size (2MB)
    if (file.size > 2 * 1024 * 1024) {
        showError('File size exceeds 2MB limit. Please choose a smaller file.');
        return;
    }
    
    uploadFile(file);
}

async function uploadFile(file) {
    const formData = new FormData();
    formData.append('logo', file);
    
    // Hide previous messages
    uploadError.style.display = 'none';
    uploadSuccess.style.display = 'none';
    
    // Show progress
    uploadProgress.style.display = 'block';
    dropZone.classList.add('uploading');
    progressBar.style.width = '50%';
    uploadStatus.textContent = 'Uploading...';
    
    try {
        const response = await fetch('/api/preferences/logo', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            progressBar.style.width = '100%';
            uploadStatus.textContent = 'Upload complete!';
            
            // Update previews
            const logoUrl = data.logo_url;
            currentLogoPreview.innerHTML = `<img src="${logoUrl}" alt="Current Logo" style="max-width: 100%; max-height: 150px; height: auto;">`;
            previewLogo.src = logoUrl;
            
            // Enable reset button
            resetLogoBtn.disabled = false;
            
            // Show success
            setTimeout(() => {
                uploadProgress.style.display = 'none';
                uploadSuccess.style.display = 'block';
                dropZone.classList.remove('uploading');
                
                // Reload page after short delay to update navbar
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }, 500);
        } else {
            throw new Error(data.error || 'Upload failed');
        }
    } catch (error) {
        uploadProgress.style.display = 'none';
        dropZone.classList.remove('uploading');
        showError(error.message || 'Failed to upload logo. Please try again.');
    }
}

function showError(message) {
    errorMessage.textContent = message;
    uploadError.style.display = 'block';
    uploadSuccess.style.display = 'none';
    uploadProgress.style.display = 'none';
}

async function resetLogo() {
    if (!confirm('Are you sure you want to reset to the default logo? This cannot be undone.')) {
        return;
    }
    
    resetLogoBtn.disabled = true;
    resetLogoBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Resetting...';
    
    try {
        const response = await fetch('/api/preferences/logo', {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Update previews to default logo
            const defaultLogoUrl = "{{ url_for('static', filename='img/logo.png') }}";
            currentLogoPreview.innerHTML = `<img src="${defaultLogoUrl}" alt="Default Logo" style="max-width: 100%; max-height: 150px; height: auto;">`;
            previewLogo.src = defaultLogoUrl;
            
            // Show success
            uploadSuccess.style.display = 'block';
            uploadError.style.display = 'none';
            
            // Reload page after short delay to update navbar
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Reset failed');
        }
    } catch (error) {
        showError(error.message || 'Failed to reset logo. Please try again.');
        resetLogoBtn.disabled = false;
        resetLogoBtn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> Reset to Default Logo';
    }
}
</script>
{% endblock %}

