{% extends "base.html" %}

{% block title %}Dashboard - Slide Reports{% endblock %}

{% block content %}
<div style="margin-top: 2rem;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Dashboard</h1>
        <div>
            <button class="btn btn-primary" id="sync-button" onclick="startSync()" {% if is_syncing %}disabled{% endif %}>
                {% if is_syncing %}
                <span class="spinner"></span> Syncing...
                {% else %}
                <i class="bi bi-arrow-repeat"></i> Sync Now
                {% endif %}
            </button>
        </div>
    </div>
    
    {% if is_syncing %}
    <div class="alert alert-info">
        <strong>Sync in progress...</strong> The page will automatically refresh when complete. This may take a few minutes for large datasets.
        <br><small>Syncing data from the last 90 days...</small>
    </div>
    <script>
    // Auto-poll if sync is in progress on page load
    window.addEventListener('DOMContentLoaded', async () => {
        window.slideReports.syncManager.isSyncing = true;
        await window.slideReports.syncManager.pollSyncStatus();
        
        // Reload after sync completes
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    });
    </script>
    {% endif %}
    
    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-lightning"></i> Quick Actions
        </div>
        <div class="card-body">
            <div class="d-grid gap-2 d-md-flex">
                <a href="{{ url_for('reports_builder') }}" class="btn btn-outline-primary">
                    <i class="bi bi-file-earmark-plus"></i> Build New Report
                </a>
                <a href="{{ url_for('email_reports_create') }}" class="btn btn-outline-primary">
                    <i class="bi bi-envelope-plus"></i> Schedule Email Report
                </a>
                <a href="{{ url_for('templates_list') }}" class="btn btn-outline-primary">
                    <i class="bi bi-layout-text-window-reverse"></i> Manage Templates
                </a>
                <a href="{{ url_for('templates_new') }}" class="btn btn-outline-primary">
                    <i class="bi bi-magic"></i> Create Template with AI
                </a>
            </div>
        </div>
    </div>
    
    <!-- Auto-Sync Settings -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-arrow-repeat"></i> Automatic Sync
            </div>
            <div class="form-check form-switch" style="margin: 0;">
                <input class="form-check-input" type="checkbox" id="auto-sync-toggle" style="cursor: pointer;" checked>
            </div>
        </div>
        <div class="card-body">
            <p class="text-muted small mb-3">
                Automatically sync your Slide data every hour in the background. You can also manually sync anytime using the "Sync Now" button above.
            </p>
            
            <div class="row">
                <div class="col-md-4">
                    <label for="sync-frequency" class="form-label small">Sync Frequency</label>
                    <select class="form-select form-select-sm" id="sync-frequency">
                        <option value="1" selected>Every hour</option>
                        <option value="2">Every 2 hours</option>
                        <option value="4">Every 4 hours</option>
                        <option value="6">Every 6 hours</option>
                        <option value="12">Every 12 hours</option>
                        <option value="24">Once per day</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <label class="form-label small">Status</label>
                    <div id="auto-sync-status" class="small">
                        <span class="status-badge status-success">Enabled</span>
                        <span id="next-sync-time" class="text-muted ms-2">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upcoming Scheduled Reports -->
    {% if upcoming_schedules %}
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-calendar-check"></i> Upcoming Scheduled Reports
            </div>
            <a href="{{ url_for('email_reports_page') }}" class="btn btn-sm btn-outline-primary">
                Manage Schedules
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Schedule</th>
                            <th>Recipient</th>
                            <th>Frequency</th>
                            <th>Next Send</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for schedule in upcoming_schedules %}
                        <tr>
                            <td>{{ schedule.name }}</td>
                            <td><small>{{ schedule.email_address }}</small></td>
                            <td>
                                {% if schedule.schedule_frequency == 'daily' %}
                                    <span class="badge badge-soft-info">Daily</span>
                                {% elif schedule.schedule_frequency == 'weekly' %}
                                    <span class="badge badge-soft-primary">Weekly</span>
                                {% elif schedule.schedule_frequency == 'monthly' %}
                                    <span class="badge badge-soft-success">Monthly</span>
                                {% endif %}
                            </td>
                            <td><small>{{ schedule.next_run_at[:16].replace('T', ' ') }} UTC</small></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Unified Data Summary & Synchronization -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-table"></i> Data Summary & Synchronization
            </div>
            <div>
                <button class="btn btn-sm btn-outline-danger me-2" onclick="clearSyncData()">
                    <i class="bi bi-trash"></i> Clear Local Data
                </button>
                <span class="text-muted small">
                    <strong>Timezone:</strong> {{ timezone }} 
                    <a href="#" onclick="changeTimezone(); return false;" class="ms-2">Change</a>
                </span>
            </div>
        </div>
        <div class="card-body">
            <p class="text-muted small mb-3">
                <i class="bi bi-info-circle"></i> Syncing last 90 days of data
            </p>
            
            <div id="sync-progress" style="display: none;">
                <h6>Syncing Data...</h6>
                <div id="sync-progress-items"></div>
            </div>
            
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="width: 30%;">Data Type</th>
                        <th style="width: 15%; text-align: right;">Count</th>
                        <th style="width: 45%;">Last Sync</th>
                        <th style="width: 10%; text-align: center;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><i class="bi bi-hdd"></i> Devices</td>
                        <td style="text-align: right; font-weight: 600;" id="count-devices">{{ counts.devices }}</td>
                        <td>
                            {% if sync_status.devices %}
                            <span class="text-muted small">{{ sync_status.devices.last_sync_friendly }}</span>
                            {% if sync_status.devices.error_message %}
                            <div class="text-danger small">{{ sync_status.devices.error_message }}</div>
                            {% endif %}
                            {% else %}
                            <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            {% if sync_status.devices and sync_status.devices.status == 'completed' %}
                            <span class="status-badge status-success">✓</span>
                            {% elif sync_status.devices and sync_status.devices.status == 'error' %}
                            <span class="status-badge status-danger">✗</span>
                            {% else %}
                            <span class="status-badge">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><i class="bi bi-server"></i> Agents</td>
                        <td style="text-align: right; font-weight: 600;" id="count-agents">{{ counts.agents }}</td>
                        <td>
                            {% if sync_status.agents %}
                            <span class="text-muted small">{{ sync_status.agents.last_sync_friendly }}</span>
                            {% if sync_status.agents.error_message %}
                            <div class="text-danger small">{{ sync_status.agents.error_message }}</div>
                            {% endif %}
                            {% else %}
                            <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            {% if sync_status.agents and sync_status.agents.status == 'completed' %}
                            <span class="status-badge status-success">✓</span>
                            {% elif sync_status.agents and sync_status.agents.status == 'error' %}
                            <span class="status-badge status-danger">✗</span>
                            {% else %}
                            <span class="status-badge">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><i class="bi bi-arrow-repeat"></i> Backups</td>
                        <td style="text-align: right; font-weight: 600;" id="count-backups">{{ counts.backups }}</td>
                        <td>
                            {% if sync_status.backups %}
                            <span class="text-muted small">{{ sync_status.backups.last_sync_friendly }}</span>
                            {% if sync_status.backups.error_message %}
                            <div class="text-danger small">{{ sync_status.backups.error_message }}</div>
                            {% endif %}
                            {% else %}
                            <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            {% if sync_status.backups and sync_status.backups.status == 'completed' %}
                            <span class="status-badge status-success">✓</span>
                            {% elif sync_status.backups and sync_status.backups.status == 'error' %}
                            <span class="status-badge status-danger">✗</span>
                            {% else %}
                            <span class="status-badge">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><i class="bi bi-camera"></i> Snapshots</td>
                        <td style="text-align: right; font-weight: 600;" id="count-snapshots">{{ counts.snapshots }}</td>
                        <td>
                            {% if sync_status.snapshots %}
                            <span class="text-muted small">{{ sync_status.snapshots.last_sync_friendly }}</span>
                            {% if sync_status.snapshots.error_message %}
                            <div class="text-danger small">{{ sync_status.snapshots.error_message }}</div>
                            {% endif %}
                            {% else %}
                            <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            {% if sync_status.snapshots and sync_status.snapshots.status == 'completed' %}
                            <span class="status-badge status-success">✓</span>
                            {% elif sync_status.snapshots and sync_status.snapshots.status == 'error' %}
                            <span class="status-badge status-danger">✗</span>
                            {% else %}
                            <span class="status-badge">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><i class="bi bi-exclamation-triangle"></i> Alerts</td>
                        <td style="text-align: right; font-weight: 600;" id="count-alerts">{{ counts.alerts }}</td>
                        <td>
                            {% if sync_status.alerts %}
                            <span class="text-muted small">{{ sync_status.alerts.last_sync_friendly }}</span>
                            {% if sync_status.alerts.error_message %}
                            <div class="text-danger small">{{ sync_status.alerts.error_message }}</div>
                            {% endif %}
                            {% else %}
                            <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            {% if sync_status.alerts and sync_status.alerts.status == 'completed' %}
                            <span class="status-badge status-success">✓</span>
                            {% elif sync_status.alerts and sync_status.alerts.status == 'error' %}
                            <span class="status-badge status-danger">✗</span>
                            {% else %}
                            <span class="status-badge">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><i class="bi bi-pc-display"></i> Virtual Machines</td>
                        <td style="text-align: right; font-weight: 600;" id="count-virtual_machines">{{ counts.virtual_machines }}</td>
                        <td>
                            {% if sync_status.virtual_machines %}
                            <span class="text-muted small">{{ sync_status.virtual_machines.last_sync_friendly }}</span>
                            {% if sync_status.virtual_machines.error_message %}
                            <div class="text-danger small">{{ sync_status.virtual_machines.error_message }}</div>
                            {% endif %}
                            {% else %}
                            <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            {% if sync_status.virtual_machines and sync_status.virtual_machines.status == 'completed' %}
                            <span class="status-badge status-success">✓</span>
                            {% elif sync_status.virtual_machines and sync_status.virtual_machines.status == 'error' %}
                            <span class="status-badge status-danger">✗</span>
                            {% else %}
                            <span class="status-badge">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><i class="bi bi-people"></i> Clients</td>
                        <td style="text-align: right; font-weight: 600;" id="count-clients">{{ counts.clients }}</td>
                        <td>
                            {% if sync_status.clients %}
                            <span class="text-muted small">{{ sync_status.clients.last_sync_friendly }}</span>
                            {% if sync_status.clients.error_message %}
                            <div class="text-danger small">{{ sync_status.clients.error_message }}</div>
                            {% endif %}
                            {% else %}
                            <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            {% if sync_status.clients and sync_status.clients.status == 'completed' %}
                            <span class="status-badge status-success">✓</span>
                            {% elif sync_status.clients and sync_status.clients.status == 'error' %}
                            <span class="status-badge status-danger">✗</span>
                            {% else %}
                            <span class="status-badge">-</span>
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Timezone Change Modal -->
<div class="modal fade" id="timezoneModal" tabindex="-1" aria-labelledby="timezoneModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="timezoneModalLabel">
                    <i class="bi bi-clock"></i> Change Timezone
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="timezone-form">
                    <div class="mb-3">
                        <label for="timezone-input" class="form-label">Select Timezone</label>
                        <input type="text" 
                               class="form-control" 
                               id="timezone-input" 
                               list="timezones-list"
                               placeholder="Start typing to search..."
                               value="{{ timezone }}"
                               autocomplete="off"
                               required>
                        <datalist id="timezones-list"></datalist>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> Type to search for your timezone. Invalid timezones will default to America/New_York.
                        </div>
                    </div>
                    <div id="timezone-error" class="alert alert-warning" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i> <span id="timezone-error-msg"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-timezone-btn" onclick="saveTimezone()">
                    <i class="bi bi-check-circle"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Common timezones list for autocomplete
const commonTimezones = [
    'America/New_York',
    'America/Chicago',
    'America/Denver',
    'America/Los_Angeles',
    'America/Phoenix',
    'America/Anchorage',
    'Pacific/Honolulu',
    'America/Toronto',
    'America/Vancouver',
    'America/Mexico_City',
    'America/Sao_Paulo',
    'Europe/London',
    'Europe/Paris',
    'Europe/Berlin',
    'Europe/Rome',
    'Europe/Madrid',
    'Europe/Amsterdam',
    'Europe/Brussels',
    'Europe/Vienna',
    'Europe/Stockholm',
    'Europe/Warsaw',
    'Europe/Athens',
    'Europe/Istanbul',
    'Europe/Moscow',
    'Asia/Dubai',
    'Asia/Karachi',
    'Asia/Kolkata',
    'Asia/Bangkok',
    'Asia/Singapore',
    'Asia/Hong_Kong',
    'Asia/Shanghai',
    'Asia/Tokyo',
    'Asia/Seoul',
    'Australia/Sydney',
    'Australia/Melbourne',
    'Australia/Brisbane',
    'Australia/Perth',
    'Pacific/Auckland',
    'Africa/Cairo',
    'Africa/Johannesburg',
    'Africa/Lagos',
    'Africa/Nairobi'
];

// Populate datalist with timezones
document.addEventListener('DOMContentLoaded', function() {
    const datalist = document.getElementById('timezones-list');
    commonTimezones.forEach(tz => {
        const option = document.createElement('option');
        option.value = tz;
        datalist.appendChild(option);
    });
});

// Load auto-sync settings on page load
document.addEventListener('DOMContentLoaded', async function() {
    await loadAutoSyncSettings();
});

async function loadAutoSyncSettings() {
    try {
        const response = await fetch('/api/sync/next');
        if (response.ok) {
            const data = await response.json();
            
            // Set toggle state
            const toggle = document.getElementById('auto-sync-toggle');
            toggle.checked = data.auto_sync_enabled;
            
            // Set frequency
            const frequency = document.getElementById('sync-frequency');
            frequency.value = data.frequency_hours.toString();
            
            // Update status display
            updateAutoSyncStatus(data);
        }
    } catch (error) {
        console.error('Failed to load auto-sync settings:', error);
    }
}

function updateAutoSyncStatus(data) {
    const statusContainer = document.getElementById('auto-sync-status');
    const statusBadge = statusContainer.querySelector('.status-badge');
    const nextSyncTime = document.getElementById('next-sync-time');
    
    if (data.auto_sync_enabled) {
        statusBadge.className = 'status-badge status-success';
        statusBadge.textContent = 'Enabled';
        
        if (data.next_sync) {
            const nextSync = new Date(data.next_sync);
            const now = new Date();
            const diffMinutes = Math.round((nextSync - now) / (1000 * 60));
            
            if (diffMinutes > 60) {
                const hours = Math.round(diffMinutes / 60);
                nextSyncTime.textContent = `Next sync in ${hours} hour${hours !== 1 ? 's' : ''}`;
            } else if (diffMinutes > 0) {
                nextSyncTime.textContent = `Next sync in ${diffMinutes} minute${diffMinutes !== 1 ? 's' : ''}`;
            } else {
                nextSyncTime.textContent = 'Next sync starting soon...';
            }
        } else {
            nextSyncTime.textContent = 'Next sync after manual sync completes';
        }
    } else {
        statusBadge.className = 'status-badge status-danger';
        statusBadge.textContent = 'Disabled';
        nextSyncTime.textContent = '';
    }
}

// Handle auto-sync toggle
document.getElementById('auto-sync-toggle').addEventListener('change', async function() {
    const enabled = this.checked;
    
    try {
        const response = await fetch('/api/preferences/auto-sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: enabled })
        });
        
        if (response.ok) {
            await loadAutoSyncSettings();
        } else {
            this.checked = !enabled;
            alert('Failed to update auto-sync setting');
        }
    } catch (error) {
        this.checked = !enabled;
        alert('Error updating auto-sync: ' + error.message);
    }
});

// Handle frequency change
document.getElementById('sync-frequency').addEventListener('change', async function() {
    const hours = parseInt(this.value);
    
    try {
        const response = await fetch('/api/preferences/auto-sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ frequency_hours: hours })
        });
        
        if (response.ok) {
            await loadAutoSyncSettings();
        } else {
            alert('Failed to update sync frequency');
            await loadAutoSyncSettings(); // Reload to reset
        }
    } catch (error) {
        alert('Error updating frequency: ' + error.message);
        await loadAutoSyncSettings(); // Reload to reset
    }
});

function startSync() {
    window.slideReports.syncManager.startSync(null);
}

function changeTimezone() {
    const modal = new bootstrap.Modal(document.getElementById('timezoneModal'));
    document.getElementById('timezone-error').style.display = 'none';
    modal.show();
}

async function saveTimezone() {
    const newTz = document.getElementById('timezone-input').value.trim();
    const saveBtn = document.getElementById('save-timezone-btn');
    const errorDiv = document.getElementById('timezone-error');
    const errorMsg = document.getElementById('timezone-error-msg');
    
    if (!newTz) {
        errorMsg.textContent = 'Please enter a timezone.';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Disable button and show loading
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
    errorDiv.style.display = 'none';
    
    try {
        const response = await fetch('/api/preferences/timezone', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ timezone: newTz })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Check if timezone was changed to default due to validation
            if (data.timezone !== newTz) {
                errorMsg.textContent = `Invalid timezone "${newTz}". Defaulting to ${data.timezone}.`;
                errorDiv.style.display = 'block';
                
                // Wait a moment so user can see the message
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                window.location.reload();
            }
        } else {
            errorMsg.textContent = data.error || 'Failed to save timezone.';
            errorDiv.style.display = 'block';
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check-circle"></i> Save Changes';
        }
    } catch (error) {
        errorMsg.textContent = 'Connection error. Please try again.';
        errorDiv.style.display = 'block';
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="bi bi-check-circle"></i> Save Changes';
    }
}

async function clearSyncData() {
    if (!confirm('Are you sure you want to clear all local synced data? This will delete all devices, backups, agents, and other synced information but keep your preferences, templates, and email schedules. You will need to sync again to rebuild the data.')) {
        return;
    }
    
    if (!confirm('This action cannot be undone. Are you absolutely sure?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/data/clear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            alert('Local data cleared successfully. The page will now reload.');
            window.location.reload();
        } else {
            const data = await response.json();
            alert('Failed to clear data: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Connection error: ' + error.message);
    }
}

// Allow Enter key to submit
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('timezone-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveTimezone();
        }
    });
});
</script>
{% endblock %}

