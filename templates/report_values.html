{% extends "base.html" %}

{% block title %}Report Template Variables - Slide Reports{% endblock %}

{% block content %}
<div style="margin-top: 2rem;">
    <h1>Report Template Variables Reference</h1>
    <p class="lead">Complete list of all variables available in report templates</p>
    
    <!-- Hero Section with Quick Actions -->
    <div class="card mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div class="card-body p-4">
            <h3 class="mb-3"><i class="bi bi-lightbulb"></i> Using Template Variables</h3>
            <p class="mb-3">
                This system uses <strong>Jinja2</strong> templating. You can create custom report templates using the variables below.
            </p>
            <div class="mb-3">
                <strong>Quick Syntax Guide:</strong>
                <ul class="mb-0 mt-2">
                    <li><code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">{{ '{{ variable }}' }}</code> - Display a variable</li>
                    <li><code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">{{ '{% if condition %}...{% endif %}' }}</code> - Conditional blocks</li>
                    <li><code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">{{ '{% for item in list %}...{% endfor %}' }}</code> - Loop through lists</li>
                </ul>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-light btn-lg" onclick="downloadJSONSchema()">
                    <i class="bi bi-download"></i> Download JSON Schema
                </button>
                <a href="{{ url_for('templates_new') }}" class="btn btn-outline-light btn-lg">
                    <i class="bi bi-magic"></i> Create Template with AI
                </a>
                <a href="{{ url_for('templates_new') }}" class="btn btn-outline-light btn-lg">
                    <i class="bi bi-code-square"></i> Import Your Own HTML
                </a>
            </div>
            <p class="mt-3 mb-0 small" style="opacity: 0.9;">
                <i class="bi bi-info-circle"></i> Download the JSON schema to use with ChatGPT, Claude, or other LLMs to generate custom templates
            </p>
        </div>
    </div>
    
    <!-- Global Variables -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-info-circle"></i> Global Metadata</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ logo_url }}' }}</code></td>
                        <td>string</td>
                        <td>URL/path to the logo image (typically <code>/static/img/logo.png</code>)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ report_title }}' }}</code></td>
                        <td>string</td>
                        <td>Title of the report (e.g., "Slide Backup Report" or with client name)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ date_range }}' }}</code></td>
                        <td>string</td>
                        <td>Human-readable date range (e.g., "January 1, 2025 - January 31, 2025")</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ generated_at }}' }}</code></td>
                        <td>string</td>
                        <td>Timestamp when the report was generated (in user's timezone)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ timezone }}' }}</code></td>
                        <td>string</td>
                        <td>User's timezone (e.g., "America/New_York")</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ client_id }}' }}</code></td>
                        <td>string|null</td>
                        <td>Client ID if filtering by client, null for all clients</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ client_name }}' }}</code></td>
                        <td>string</td>
                        <td>Client name (only present when filtering by client)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ exec_summary }}' }}</code></td>
                        <td>string</td>
                        <td>AI-generated executive summary (generated automatically if placeholder present)</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Conditional Flags -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-check-square"></i> Data Source Flags</h3>
        </div>
        <div class="card-body">
            <p>Use these flags to conditionally show/hide sections:</p>
            <table class="table">
                <tbody>
                    <tr>
                        <td><code>{{ '{% if show_backup_stats %}' }}</code></td>
                        <td>True if backups data source is selected</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{% if show_snapshots %}' }}</code></td>
                        <td>True if snapshots data source is selected</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{% if show_alerts %}' }}</code></td>
                        <td>True if alerts data source is selected</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{% if show_storage %}' }}</code></td>
                        <td>True if devices/storage data source is selected</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{% if show_audits %}' }}</code></td>
                        <td>True if audits data source is selected</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{% if show_virtualization %}' }}</code></td>
                        <td>True if virtual_machines data source is selected</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Backup Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-arrow-repeat"></i> Backup Statistics</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ total_backups }}' }}</code></td>
                        <td>int</td>
                        <td>Total number of backups in the reporting period</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ successful_backups }}' }}</code></td>
                        <td>int</td>
                        <td>Number of successful backups</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ failed_backups }}' }}</code></td>
                        <td>int</td>
                        <td>Number of failed backups</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ success_rate }}' }}</code></td>
                        <td>float</td>
                        <td>Success percentage (0-100)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ agent_backup_status }}' }}</code></td>
                        <td>list</td>
                        <td>List of dicts with per-agent backup status. Each has: <code>name</code>, <code>last_backup</code>, <code>status</code>, <code>status_class</code>, <code>duration</code></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Snapshot Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-camera"></i> Snapshot Metrics</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ active_snapshots }}' }}</code></td>
                        <td>int</td>
                        <td>Number of active (not deleted) snapshots</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ deleted_snapshots }}' }}</code></td>
                        <td>int</td>
                        <td>Number of deleted snapshots</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ local_snapshots }}' }}</code></td>
                        <td>int</td>
                        <td>Number of snapshots in local storage</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ cloud_snapshots }}' }}</code></td>
                        <td>int</td>
                        <td>Number of snapshots in cloud storage</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ retention_deleted_count }}' }}</code></td>
                        <td>int</td>
                        <td>Number of snapshots deleted by retention policy (normal)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ manually_deleted_count }}' }}</code></td>
                        <td>int</td>
                        <td>Number of manually deleted snapshots (should be uncommon)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ deletion_details }}' }}</code></td>
                        <td>list</td>
                        <td>List of up to 20 deletion records with: <code>snapshot_id</code>, <code>reason</code>, <code>location</code>, <code>deleted_at</code></td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ latest_screenshot }}' }}</code></td>
                        <td>dict|null</td>
                        <td>Latest verification screenshot with: <code>url</code>, <code>agent_name</code>, <code>captured_at</code></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Alert Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Alert Metrics</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ total_alerts }}' }}</code></td>
                        <td>int</td>
                        <td>Total number of alerts in the reporting period</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ unresolved_alerts }}' }}</code></td>
                        <td>int</td>
                        <td>Number of alerts still unresolved</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ resolved_alerts }}' }}</code></td>
                        <td>int</td>
                        <td>Number of resolved alerts</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Storage Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-hdd"></i> Storage Metrics</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ device_storage }}' }}</code></td>
                        <td>list</td>
                        <td>List of devices with storage info. Each has: <code>name</code>, <code>used</code> (formatted), <code>total</code> (formatted), <code>percent</code> (0-100)</td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Example usage:</strong></p>
            <pre><code>{{ '{% for device in device_storage %}' }}
  {{ '{{ device.name }}: {{ device.used }} / {{ device.total }} ({{ device.percent }}%)' }}
{{ '{% endfor %}' }}</code></pre>
        </div>
    </div>

    <!-- Virtualization Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-pc-display"></i> Virtualization Metrics</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ total_vms }}' }}</code></td>
                        <td>int</td>
                        <td>Total number of virtual machines</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ running_vms }}' }}</code></td>
                        <td>int</td>
                        <td>Number of running VMs</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ stopped_vms }}' }}</code></td>
                        <td>int</td>
                        <td>Number of stopped VMs</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Audit Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-clipboard-data"></i> Audit Metrics</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ total_audits }}' }}</code></td>
                        <td>int</td>
                        <td>Total number of audit log entries</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ audit_actions }}' }}</code></td>
                        <td>dict</td>
                        <td>Dictionary of action types with counts (e.g., {{"{'create': 10, 'delete': 5}"}}</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ recent_audits }}' }}</code></td>
                        <td>list</td>
                        <td>Up to 20 most recent audit entries with full details</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Calendar Grid Data -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-calendar3"></i> Calendar Grid Data</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ agent_calendars }}' }}</code></td>
                        <td>list</td>
                        <td>List of calendar objects per agent. Each has: <code>agent_name</code>, <code>agent_id</code>, <code>calendar_grid</code> (list of day objects)</td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Calendar Grid Day Object Structure:</strong></p>
            <ul>
                <li><code>date</code> - Date string (YYYY-MM-DD)</li>
                <li><code>day_of_week</code> - Day abbreviation (Mon, Tue, etc.)</li>
                <li><code>day_number</code> - Day of month (1-31)</li>
                <li><code>backup_status</code> - Status: 'success', 'failed', 'running', or 'none'</li>
                <li><code>total_backups</code> - Total number of backups that occurred this day</li>
                <li><code>successful_backups</code> - Number of successful backups</li>
                <li><code>failed_backups</code> - Number of failed backups</li>
                <li><code>snapshots_remaining</code> - Number of snapshots retained (not deleted by retention)</li>
                <li><code>completion_color</code> - Color indicator: 'green', 'yellow', 'red', or 'none'</li>
                <li><code>has_snapshot</code> - Boolean indicating if snapshot exists from this day</li>
            </ul>
            <p><strong>Example usage:</strong></p>
            <pre><code>{{ '{% for agent_cal in agent_calendars %}' }}
  {{ '<h3>{{ agent_cal.agent_name }}</h3>' }}
  {{ '{% for day in agent_cal.calendar_grid %}' }}
    {{ '<div>{{ day.day_number }}: {{ day.backup_status }}</div>' }}
  {{ '{% endfor %}' }}
{{ '{% endfor %}' }}</code></pre>
        </div>
    </div>

    <!-- Screenshot Pairs -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-images"></i> Screenshot Pairs</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ agent_screenshots }}' }}</code></td>
                        <td>list</td>
                        <td>List of screenshot pairs per agent. Each has: <code>agent_name</code>, <code>agent_id</code>, <code>oldest_screenshot</code>, <code>newest_screenshot</code></td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Screenshot Object Structure:</strong></p>
            <ul>
                <li><code>url</code> - Full URL to screenshot image</li>
                <li><code>date</code> - Formatted date/time string</li>
                <li><code>snapshot_id</code> - Snapshot identifier (truncated)</li>
            </ul>
            <p><strong>Example usage:</strong></p>
            <pre><code>{{ '{% for agent in agent_screenshots %}' }}
  {{ '<h3>{{ agent.agent_name }}</h3>' }}
  {{ '{% if agent.oldest_screenshot %}' }}
    {{ '<img src="{{ agent.oldest_screenshot.url }}" alt="Oldest">' }}
  {{ '{% endif %}' }}
  {{ '{% if agent.newest_screenshot %}' }}
    {{ '<img src="{{ agent.newest_screenshot.url }}" alt="Newest">' }}
  {{ '{% endif %}' }}
{{ '{% endfor %}' }}</code></pre>
        </div>
    </div>

    <!-- Storage Growth -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-graph-up"></i> Storage Growth Metrics</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ storage_growth }}' }}</code></td>
                        <td>dict</td>
                        <td>Overall storage growth metrics with: <code>start_bytes</code>, <code>end_bytes</code>, <code>growth_bytes</code>, <code>growth_percent</code>, <code>start_formatted</code>, <code>end_formatted</code>, <code>growth_formatted</code>, <code>is_growth</code></td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ device_storage_growth }}' }}</code></td>
                        <td>list</td>
                        <td>List of per-device growth metrics. Each device has: <code>device_name</code>, <code>start_bytes</code>, <code>end_bytes</code>, <code>growth_bytes</code>, <code>growth_percent</code>, and formatted versions</td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Example usage:</strong></p>
            <pre><code>{{ '<p>Overall growth: {{ storage_growth.growth_formatted }} ({{ storage_growth.growth_percent }}%)</p>' }}

{{ '{% for device in device_storage_growth %}' }}
  {{ '<p>{{ device.device_name }}: {{ device.growth_formatted }}</p>' }}
{{ '{% endfor %}' }}</code></pre>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h3>
        </div>
        <div class="card-body">
            <a href="{{ url_for('templates_list') }}" class="btn btn-primary">
                <i class="bi bi-layout-text-window-reverse"></i> View Templates
            </a>
            <a href="{{ url_for('templates_new') }}" class="btn btn-success">
                <i class="bi bi-magic"></i> Create New Template
            </a>
        </div>
    </div>
</div>

<script>
async function downloadJSONSchema() {
    try {
        const response = await fetch('/api/template-schema.json');
        if (!response.ok) {
            throw new Error('Failed to fetch schema');
        }
        
        const schema = await response.json();
        const schemaStr = JSON.stringify(schema, null, 2);
        const blob = new Blob([schemaStr], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'slide-report-template-schema.json';
        document.body.appendChild(a);
        a.click();
        
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        window.slideReports.utils.showToast('Schema downloaded successfully', 'success');
    } catch (error) {
        console.error('Download error:', error);
        alert('Failed to download schema: ' + error.message);
    }
}
</script>
{% endblock %}

