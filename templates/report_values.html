{% extends "base.html" %}

{% block title %}Report Template Variables - Slide Reports{% endblock %}

{% block content %}
<div style="margin-top: 2rem;">
    <h1>Report Template Variables Reference</h1>
    <p class="lead">Complete list of all variables available in report templates</p>
    
    <!-- Hero Section with Quick Actions -->
    <div class="card mb-4" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); color: white;">
        <div class="card-body p-4">
            <h3 class="mb-3"><i class="bi bi-lightbulb"></i> Using Template Variables</h3>
            <p class="mb-3">
                This system uses <strong>Jinja2</strong> templating. You can create custom report templates using the variables below.
            </p>
            <div class="mb-3">
                <strong>Quick Syntax Guide:</strong>
                <ul class="mb-0 mt-2">
                    <li><code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">{{ '{{ variable }}' }}</code> - Display a variable</li>
                    <li><code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">{{ '{% if condition %}...{% endif %}' }}</code> - Conditional blocks</li>
                    <li><code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">{{ '{% for item in list %}...{% endfor %}' }}</code> - Loop through lists</li>
                </ul>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-light btn-lg" onclick="downloadJSONSchema()">
                    <i class="bi bi-download"></i> Download JSON Schema
                </button>
                <a href="{{ url_for('templates_new') }}" class="btn btn-outline-light btn-lg">
                    <i class="bi bi-magic"></i> Create Template with AI
                </a>
                <a href="{{ url_for('templates_new') }}" class="btn btn-outline-light btn-lg">
                    <i class="bi bi-code-square"></i> Import Your Own HTML
                </a>
            </div>
            <p class="mt-3 mb-0 small" style="opacity: 0.9;">
                <i class="bi bi-info-circle"></i> Download the JSON schema to use with ChatGPT, Claude, or other LLMs to generate custom templates
            </p>
        </div>
    </div>
    
    <!-- Global Variables -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-info-circle"></i> Global Metadata</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ logo_url }}' }}</code></td>
                        <td>string</td>
                        <td>URL/path to the logo image (typically <code>/static/img/logo.png</code>)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ report_title }}' }}</code></td>
                        <td>string</td>
                        <td>Title of the report (e.g., "Slide Backup Report" or with client name)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ date_range }}' }}</code></td>
                        <td>string</td>
                        <td>Human-readable date range (e.g., "January 1, 2025 - January 31, 2025")</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ generated_at }}' }}</code></td>
                        <td>string</td>
                        <td>Timestamp when the report was generated (in user's timezone)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ timezone }}' }}</code></td>
                        <td>string</td>
                        <td>User's timezone (e.g., "America/New_York")</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ client_id }}' }}</code></td>
                        <td>string|null</td>
                        <td>Client ID if filtering by client, null for all clients</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ client_name }}' }}</code></td>
                        <td>string</td>
                        <td>Client name (only present when filtering by client)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ exec_summary }}' }}</code></td>
                        <td>string</td>
                        <td>AI-generated executive summary (generated automatically if placeholder present)</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Conditional Flags -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-check-square"></i> Data Source Flags</h3>
        </div>
        <div class="card-body">
            <p>Use these flags to conditionally show/hide sections:</p>
            <table class="table">
                <tbody>
                    <tr>
                        <td><code>{{ '{% if show_backup_stats %}' }}</code></td>
                        <td>True if backups data source is selected</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{% if show_snapshots %}' }}</code></td>
                        <td>True if snapshots data source is selected</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{% if show_alerts %}' }}</code></td>
                        <td>True if alerts data source is selected</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{% if show_storage %}' }}</code></td>
                        <td>True if devices/storage data source is selected</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{% if show_audits %}' }}</code></td>
                        <td>True if audits data source is selected</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{% if show_virtualization %}' }}</code></td>
                        <td>True if virtual_machines data source is selected</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Backup Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-arrow-repeat"></i> Backup Statistics</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ total_backups }}' }}</code></td>
                        <td>int</td>
                        <td>Total number of backups in the reporting period</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ successful_backups }}' }}</code></td>
                        <td>int</td>
                        <td>Number of successful backups</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ failed_backups }}' }}</code></td>
                        <td>int</td>
                        <td>Number of failed backups</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ success_rate }}' }}</code></td>
                        <td>float</td>
                        <td>Success percentage (0-100)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ agent_backup_status }}' }}</code></td>
                        <td>list</td>
                        <td>List of dicts with per-agent backup status. Each has: <code>name</code>, <code>last_backup</code>, <code>status</code>, <code>status_class</code>, <code>duration</code></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Snapshot Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-camera"></i> Snapshot Metrics</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ active_snapshots }}' }}</code></td>
                        <td>int</td>
                        <td>Number of active (not deleted) snapshots</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ deleted_snapshots }}' }}</code></td>
                        <td>int</td>
                        <td>Number of deleted snapshots</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ local_snapshots }}' }}</code></td>
                        <td>int</td>
                        <td>Number of snapshots in local storage</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ cloud_snapshots }}' }}</code></td>
                        <td>int</td>
                        <td>Number of snapshots in cloud storage</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ retention_deleted_count }}' }}</code></td>
                        <td>int</td>
                        <td>Number of snapshots deleted by retention policy (normal)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ manually_deleted_count }}' }}</code></td>
                        <td>int</td>
                        <td>Number of manually deleted snapshots (should be uncommon)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ deletion_details }}' }}</code></td>
                        <td>list</td>
                        <td>List of up to 20 deletion records with: <code>snapshot_id</code>, <code>reason</code>, <code>location</code>, <code>deleted_at</code></td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ latest_screenshot }}' }}</code></td>
                        <td>dict|null</td>
                        <td>Latest verification screenshot with: <code>url</code>, <code>agent_name</code>, <code>captured_at</code></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Alert Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Alert Metrics</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ total_alerts }}' }}</code></td>
                        <td>int</td>
                        <td>Total number of alerts in the reporting period</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ unresolved_alerts }}' }}</code></td>
                        <td>int</td>
                        <td>Number of alerts still unresolved</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ resolved_alerts }}' }}</code></td>
                        <td>int</td>
                        <td>Number of resolved alerts</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Storage Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-hdd"></i> Storage Metrics</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ device_storage }}' }}</code></td>
                        <td>list</td>
                        <td>List of devices with storage info. Each has: <code>name</code>, <code>used</code> (formatted), <code>total</code> (formatted), <code>percent</code> (0-100)</td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Example usage:</strong></p>
            <pre><code>{{ '{% for device in device_storage %}' }}
  {{ '{{ device.name }}: {{ device.used }} / {{ device.total }} ({{ device.percent }}%)' }}
{{ '{% endfor %}' }}</code></pre>
        </div>
    </div>

    <!-- Agent Snapshot Totals -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-collection"></i> Agent Snapshot Totals</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ agent_snapshot_totals }}' }}</code></td>
                        <td>list</td>
                        <td>List of snapshot totals per agent. Each has: <code>agent_name</code>, <code>local_count</code>, <code>cloud_count</code></td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Example usage:</strong></p>
            <pre><code>{{ '{% for agent in agent_snapshot_totals %}' }}
  {{ '{{ agent.agent_name }}: {{ agent.local_count }} local, {{ agent.cloud_count }} cloud' }}
{{ '{% endfor %}' }}</code></pre>
        </div>
    </div>

    <!-- Snapshot Audit Data -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-camera-fill"></i> Snapshot Audit Data</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ agent_snapshot_audit }}' }}</code></td>
                        <td>list</td>
                        <td>List of agents with complete snapshot audit data. Each agent has: <code>agent_name</code>, <code>agent_id</code>, <code>snapshots</code> (array of snapshot objects)</td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Snapshot Object Structure (within each agent):</strong></p>
            <ul>
                <li><code>date_formatted</code> - Formatted snapshot date/time in user timezone</li>
                <li><code>location_local</code> - Boolean, true if snapshot exists locally</li>
                <li><code>location_cloud</code> - Boolean, true if snapshot exists in cloud</li>
                <li><code>verify_boot_passed</code> - Boolean, true if screenshot verification status is "success"</li>
                <li><code>verify_fs_passed</code> - Boolean, true if filesystem verification status is "success"</li>
                <li><code>screenshot_url</code> - URL to verification screenshot (or None)</li>
            </ul>
            <p><strong>Example usage:</strong></p>
            <pre><code>{{ '{% for agent_data in agent_snapshot_audit %}' }}
  {{ '<h3>{{ agent_data.agent_name }}</h3>' }}
  {{ '<table>' }}
    {{ '<tr>' }}
      {{ '<th>Date</th><th>Location</th><th>Verified</th>' }}
    {{ '</tr>' }}
    {{ '{% for snapshot in agent_data.snapshots %}' }}
    {{ '<tr>' }}
      {{ '<td>{{ snapshot.date_formatted }}</td>' }}
      {{ '<td>' }}
        {{ '{% if snapshot.location_local %}Local {% endif %}' }}
        {{ '{% if snapshot.location_cloud %}Cloud{% endif %}' }}
      {{ '</td>' }}
      {{ '<td>' }}
        {{ '{% if snapshot.verify_boot_passed %}✓{% endif %}' }}
      {{ '</td>' }}
    {{ '</tr>' }}
    {{ '{% endfor %}' }}
  {{ '</table>' }}
{{ '{% endfor %}' }}</code></pre>
        </div>
    </div>

    <!-- Virtualization Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-pc-display"></i> Virtualization Metrics</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ total_vms }}' }}</code></td>
                        <td>int</td>
                        <td>Total number of virtual machines</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ running_vms }}' }}</code></td>
                        <td>int</td>
                        <td>Number of running VMs</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ stopped_vms }}' }}</code></td>
                        <td>int</td>
                        <td>Number of stopped VMs</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Audit Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-clipboard-data"></i> Audit Metrics</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ total_audits }}' }}</code></td>
                        <td>int</td>
                        <td>Total number of audit log entries</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ audit_actions }}' }}</code></td>
                        <td>dict</td>
                        <td>Dictionary of action types with counts (e.g., {{"{'create': 10, 'delete': 5}"}}</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ recent_audits }}' }}</code></td>
                        <td>list</td>
                        <td>Up to 20 most recent audit entries with full details</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Calendar Grid Data -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-calendar3"></i> Calendar Grid Data</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ agent_calendars }}' }}</code></td>
                        <td>list</td>
                        <td>List of calendar objects per agent. Each has: <code>agent_name</code>, <code>agent_id</code>, <code>calendar_grid</code> (list of day objects)</td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Calendar Grid Day Object Structure:</strong></p>
            <ul>
                <li><code>date</code> - Date string (YYYY-MM-DD)</li>
                <li><code>day_of_week</code> - Day abbreviation (Mon, Tue, etc.)</li>
                <li><code>day_number</code> - Day of month (1-31)</li>
                <li><code>backup_status</code> - Status: 'success', 'failed', 'running', or 'none'</li>
                <li><code>total_backups</code> - Total number of backups that occurred this day</li>
                <li><code>successful_backups</code> - Number of successful backups</li>
                <li><code>failed_backups</code> - Number of failed backups</li>
                <li><code>snapshots_created</code> - Number of snapshots created on this day</li>
                <li><code>local_snapshots</code> - Number of local snapshots existing for this day</li>
                <li><code>cloud_snapshots</code> - Number of cloud snapshots existing for this day</li>
                <li><code>completion_color</code> - Color indicator: 'green', 'yellow', 'red', or 'none'</li>
                <li><code>has_snapshot</code> - Boolean indicating if snapshot exists from this day</li>
            </ul>
            <p><strong>Example usage:</strong></p>
            <pre><code>{{ '{% for agent_cal in agent_calendars %}' }}
  {{ '<h3>{{ agent_cal.agent_name }}</h3>' }}
  {{ '{% for day in agent_cal.calendar_grid %}' }}
    {{ '<div>{{ day.day_number }}: {{ day.backup_status }}</div>' }}
  {{ '{% endfor %}' }}
{{ '{% endfor %}' }}</code></pre>
        </div>
    </div>

    <!-- Screenshot Pairs -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-images"></i> Screenshot Pairs</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ agent_screenshots }}' }}</code></td>
                        <td>list</td>
                        <td>List of screenshot pairs per agent. Each has: <code>agent_name</code>, <code>agent_id</code>, <code>oldest_screenshot</code>, <code>newest_screenshot</code></td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Screenshot Object Structure:</strong></p>
            <ul>
                <li><code>url</code> - Full URL to screenshot image</li>
                <li><code>date</code> - Formatted date/time string</li>
                <li><code>snapshot_id</code> - Snapshot identifier (truncated)</li>
            </ul>
            <p><strong>Example usage:</strong></p>
            <pre><code>{{ '{% for agent in agent_screenshots %}' }}
  {{ '<h3>{{ agent.agent_name }}</h3>' }}
  {{ '{% if agent.oldest_screenshot %}' }}
    {{ '<img src="{{ agent.oldest_screenshot.url }}" alt="Oldest">' }}
  {{ '{% endif %}' }}
  {{ '{% if agent.newest_screenshot %}' }}
    {{ '<img src="{{ agent.newest_screenshot.url }}" alt="Newest">' }}
  {{ '{% endif %}' }}
{{ '{% endfor %}' }}</code></pre>
        </div>
    </div>

    <!-- Storage Growth -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-graph-up"></i> Storage Growth Metrics <span class="badge bg-warning text-dark">Deprecated</span></h3>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <strong>Note:</strong> Storage Growth metrics have been removed from built-in templates (Weekly, Monthly, Quarterly) but are still available for custom templates.
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ storage_growth }}' }}</code></td>
                        <td>dict</td>
                        <td>Overall storage growth metrics with: <code>start_bytes</code>, <code>end_bytes</code>, <code>growth_bytes</code>, <code>growth_percent</code>, <code>start_formatted</code>, <code>end_formatted</code>, <code>growth_formatted</code>, <code>is_growth</code></td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ device_storage_growth }}' }}</code></td>
                        <td>list</td>
                        <td>List of per-device growth metrics. Each device has: <code>device_name</code>, <code>start_bytes</code>, <code>end_bytes</code>, <code>growth_bytes</code>, <code>growth_percent</code>, and formatted versions</td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Example usage:</strong></p>
            <pre><code>{{ '<p>Overall growth: {{ storage_growth.growth_formatted }} ({{ storage_growth.growth_percent }}%)</p>' }}

{{ '{% for device in device_storage_growth %}' }}
  {{ '<p>{{ device.device_name }}: {{ device.growth_formatted }}</p>' }}
{{ '{% endfor %}' }}</code></pre>
        </div>
    </div>

    <!-- Agent Configuration Overview -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-gear"></i> Agent Configuration Overview</h3>
        </div>
        <div class="card-body">
            <p>Comprehensive configuration overview with devices grouped with their agents, including outlier detection for backup performance and configuration differences.</p>
            
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ agent_config_overview }}' }}</code></td>
                        <td>dict</td>
                        <td>Contains <code>devices</code> (list) and <code>summary</code> (dict) with configuration and backup metrics</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ agent_config_overview.summary }}' }}</code></td>
                        <td>dict</td>
                        <td>Summary with: <code>total_devices</code>, <code>total_agents</code>, <code>slow_backup_count</code> (&gt;30min), <code>old_backup_count</code> (&gt;7d), <code>config_outlier_count</code></td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ agent_config_overview.devices }}' }}</code></td>
                        <td>list</td>
                        <td>List of device objects, each containing <code>device_info</code> and <code>agents</code> array</td>
                    </tr>
                </tbody>
            </table>
            
            <p><strong>Device Object Structure:</strong></p>
            <ul>
                <li><code>device_info</code> - Full device configuration (all device database fields: device_id, hostname, os, storage, etc.)</li>
                <li><code>agents</code> - Array of agent objects for this device</li>
            </ul>
            
            <p><strong>Agent Object Structure:</strong></p>
            <ul>
                <li><code>agent_info</code> - Full agent configuration (all agent fields: agent_id, hostname, os, os_version, arch, platform, agent_version, encryption_algorithm, firmware_type, manufacturer, sealed, vss_writer_configs, passphrases, ip_addresses, etc.)</li>
                <li><code>last_successful_backup_date</code> - Formatted date/time of last successful backup (e.g., "9:24AM Oct 17th 2025 EDT")</li>
                <li><code>last_backup_duration_minutes</code> - Duration in minutes (integer or None)</li>
                <li><code>last_backup_duration_seconds</code> - Duration in seconds (integer or None)</li>
                <li><code>is_slow_backup</code> - Boolean, true if backup took &gt;30 minutes</li>
                <li><code>is_old_backup</code> - Boolean, true if last backup was &gt;7 days ago</li>
                <li><code>config_outlier</code> - Boolean, true if agent config differs from majority</li>
                <li><code>ip_addresses_formatted</code> - Formatted IP addresses as comma-separated string</li>
                <li><code>last_seen_formatted</code> - Formatted last seen date (e.g., "9:24AM Oct 17th 2025 EDT")</li>
                <li><code>last_screenshot_url</code> - URL to latest snapshot screenshot (or None)</li>
            </ul>
            
            <p><strong>Example usage:</strong></p>
            <pre><code>{{ '<p>Total: {{ agent_config_overview.summary.total_agents }} agents</p>' }}
{{ '<p>Slow backups: {{ agent_config_overview.summary.slow_backup_count }}</p>' }}

{{ '{% for device_group in agent_config_overview.devices %}' }}
  {{ '<h3>Device: {{ device_group.device_info.hostname }}</h3>' }}
  {{ '<p>OS: {{ device_group.device_info.os }}</p>' }}
  
  {{ '{% for agent in device_group.agents %}' }}
    {{ '<div {% if agent.is_slow_backup %}style="background: red;"{% endif %}>' }}
      {{ '<h4>{{ agent.agent_info.display_name or agent.agent_info.hostname }}</h4>' }}
      {{ '<p>OS: {{ agent.agent_info.os }} {{ agent.agent_info.os_version }}</p>' }}
      {{ '<p>Platform: {{ agent.agent_info.platform }}</p>' }}
      {{ '<p>Agent Version: {{ agent.agent_info.agent_version }}</p>' }}
      {{ '<p>Encryption: {{ agent.agent_info.encryption_algorithm }}</p>' }}
      {{ '<p>Last Backup: {{ agent.last_successful_backup_date }}</p>' }}
      {{ '<p>Duration: {{ agent.last_backup_duration_minutes }} min</p>' }}
      {{ '{% if agent.config_outlier %}' }}
        {{ '<span>Config Outlier</span>' }}
      {{ '{% endif %}' }}
    {{ '</div>' }}
  {{ '{% endfor %}' }}
{{ '{% endfor %}' }}</code></pre>
        </div>
    </div>

    <!-- Agent Overview Data -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-people"></i> Agent Overview Data</h3>
        </div>
        <div class="card-body">
            <p>Summary data for the Agent Overview report showing agent backup status, cloud snapshots, and screenshots for a specific date range.</p>
            
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Variable</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 60%;">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ agent_overview_data }}' }}</code></td>
                        <td>dict</td>
                        <td>Contains <code>summary</code> (dict), <code>agents</code> (list), and <code>has_multiple_clients</code> (boolean)</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ agent_overview_data.summary }}' }}</code></td>
                        <td>dict</td>
                        <td>Summary metrics: <code>total_agents</code>, <code>successful_backups</code>, <code>failed_backups</code>, <code>success_percentage</code></td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ agent_overview_data.agents }}' }}</code></td>
                        <td>list</td>
                        <td>List of agent objects with backup status information</td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ agent_overview_data.has_multiple_clients }}' }}</code></td>
                        <td>boolean</td>
                        <td>True if there are multiple clients in the system (use for conditional client column display)</td>
                    </tr>
                </tbody>
            </table>
            
            <p><strong>Agent Object Structure:</strong></p>
            <ul>
                <li><code>agent_name</code> - Agent display name, hostname, or agent_id</li>
                <li><code>client_name</code> - Client name (only present if multiple clients exist, otherwise None)</li>
                <li><code>last_backup</code> - Most recent successful backup datetime (formatted, or None if no successful backups in date range)</li>
                <li><code>last_cloud</code> - Newest snapshot in cloud location (formatted, or None if no cloud snapshots in date range)</li>
                <li><code>last_screenshot_url</code> - URL to newest screenshot image (or None if no screenshots in date range)</li>
            </ul>
            
            <p><strong>Example usage:</strong></p>
            <pre><code>{{ '<h2>Summary</h2>' }}
{{ '<p>Total Agents: {{ agent_overview_data.summary.total_agents }}</p>' }}
{{ '<p>Successful: {{ agent_overview_data.summary.successful_backups }}</p>' }}
{{ '<p>Failed: {{ agent_overview_data.summary.failed_backups }}</p>' }}
{{ '<p>Success Rate: {{ agent_overview_data.summary.success_percentage }}%</p>' }}

{{ '<table>' }}
  {{ '<tr>' }}
    {{ '{% if agent_overview_data.has_multiple_clients %}' }}
    {{ '<th>Client</th>' }}
    {{ '{% endif %}' }}
    {{ '<th>Agent</th><th>Last Backup</th><th>Last Cloud</th><th>Last Screenshot</th>' }}
  {{ '</tr>' }}
  {{ '{% for agent in agent_overview_data.agents %}' }}
  {{ '<tr>' }}
    {{ '{% if agent_overview_data.has_multiple_clients %}' }}
    {{ '<td>{{ agent.client_name or "N/A" }}</td>' }}
    {{ '{% endif %}' }}
    {{ '<td>{{ agent.agent_name }}</td>' }}
    {{ '<td>{{ agent.last_backup or "Never" }}</td>' }}
    {{ '<td>{{ agent.last_cloud or "None" }}</td>' }}
    {{ '<td>' }}
      {{ '{% if agent.last_screenshot_url %}' }}
        {{ '<img src="{{ agent.last_screenshot_url }}" alt="Screenshot" style="width: 80px;">' }}
      {{ '{% else %}' }}
        {{ 'None' }}
      {{ '{% endif %}' }}
    {{ '</td>' }}
  {{ '</tr>' }}
  {{ '{% endfor %}' }}
{{ '</table>' }}</code></pre>
        </div>
    </div>

    <!-- Raw Data Arrays -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-database"></i> Raw Data Arrays (Advanced)</h3>
        </div>
        <div class="card-body">
            <p class="alert alert-warning">
                <strong>⚠️ Important:</strong> These are raw database records. Fields may be <code>None/null</code>. 
                <strong>All datetime fields are ISO format STRINGS</strong>, not datetime objects. 
                Always check for null values and don't use datetime operations like <code>.days</code> or <code>.strftime()</code>.
            </p>
            <p>These arrays provide access to raw database records for advanced template customization. 
               They are filtered by <code>client_id</code> if specified, and limited to the reporting date range where applicable.</p>
            
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Array</th>
                        <th style="width: 75%;">Available Fields</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>{{ '{{ devices }}' }}</code></td>
                        <td><code>device_id</code>, <code>display_name</code>, <code>hostname</code>, <code>last_seen_at</code>, <code>booted_at</code>, <code>ip_addresses</code>, <code>os</code>, <code>os_version</code>, <code>arch</code>, <code>client_id</code>, <code>storage_used_bytes</code>, <code>storage_total_bytes</code></td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ agents }}' }}</code></td>
                        <td><code>agent_id</code>, <code>device_id</code>, <code>display_name</code>, <code>hostname</code>, <code>last_seen_at</code>, <code>booted_at</code>, <code>ip_addresses</code>, <code>os</code>, <code>os_version</code>, <code>arch</code>, <code>client_id</code></td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ backups }}' }}</code></td>
                        <td><code>backup_id</code>, <code>agent_id</code>, <code>started_at</code> (STRING), <code>ended_at</code> (STRING), <code>status</code>, <code>error_code</code>, <code>error_message</code>, <code>snapshot_id</code></td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ snapshots }}' }}</code></td>
                        <td><code>snapshot_id</code>, <code>agent_id</code>, <code>backup_started_at</code> (STRING), <code>backup_ended_at</code> (STRING), <code>locations</code>, <code>deleted</code>, <code>deletions</code>, <code>verify_boot_screenshot_url</code>, <code>exists_local</code>, <code>exists_cloud</code>, <code>exists_deleted</code></td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ alerts }}' }}</code></td>
                        <td><code>alert_id</code>, <code>alert_type</code>, <code>alert_fields</code>, <code>created_at</code> (STRING), <code>resolved</code> (0/1), <code>device_id</code>, <code>agent_id</code></td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ virtual_machines }}' }}</code></td>
                        <td><code>virt_id</code>, <code>device_id</code>, <code>agent_id</code>, <code>snapshot_id</code>, <code>state</code>, <code>created_at</code> (STRING), <code>expires_at</code> (STRING), <code>cpu_count</code>, <code>memory_in_mb</code></td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ audits }}' }}</code></td>
                        <td><code>audit_id</code>, <code>audit_time</code> (STRING), <code>account_id</code>, <code>client_id</code>, <code>user_id</code>, <code>action</code>, <code>resource_type</code>, <code>resource_id</code>, <code>note</code></td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ clients }}' }}</code></td>
                        <td><code>client_id</code>, <code>name</code>, <code>comments</code></td>
                    </tr>
                    <tr>
                        <td><code>{{ '{{ file_restores }}' }}</code></td>
                        <td><code>file_restore_id</code>, <code>device_id</code>, <code>agent_id</code>, <code>snapshot_id</code>, <code>created_at</code> (STRING), <code>expires_at</code> (STRING)</td>
                    </tr>
                </tbody>
            </table>
            
            <h5 class="mt-4">Common Patterns</h5>
            <p><strong>Getting Device/Agent Names:</strong></p>
            <pre><code>{{ '{# Device name - display_name is preferred, falls back to hostname #}' }}
{{ '{{ device.display_name or device.hostname or device.device_id }}' }}

{{ '{# Agent name - same pattern #}' }}
{{ '{{ agent.display_name or agent.hostname or agent.agent_id }}' }}</code></pre>
            
            <p><strong>Looping Through All Devices:</strong></p>
            <pre><code>{{ '{% for device in devices %}' }}
  {{ '<div class="device">' }}
    {{ '<h4>{{ device.display_name or device.hostname }}</h4>' }}
    {{ '<p>OS: {{ device.os or "Unknown" }} {{ device.os_version or "" }}</p>' }}
    {{ '{% if device.storage_used_bytes and device.storage_total_bytes %}' }}
      {{ '<p>Storage: {{ (device.storage_used_bytes / 1024**3)|round(1) }} GB / {{ (device.storage_total_bytes / 1024**3)|round(1) }} GB</p>' }}
    {{ '{% endif %}' }}
  {{ '</div>' }}
{{ '{% endfor %}' }}</code></pre>
            
            <p><strong>Looping Through All Agents:</strong></p>
            <pre><code>{{ '{% for agent in agents %}' }}
  {{ '<div class="agent">' }}
    {{ '<h4>{{ agent.display_name or agent.hostname }}</h4>' }}
    {{ '<p>ID: {{ agent.agent_id }}</p>' }}
    {{ '{% if agent.os %}' }}
      {{ '<p>OS: {{ agent.os }} {{ agent.arch or "" }}</p>' }}
    {{ '{% endif %}' }}
  {{ '</div>' }}
{{ '{% endfor %}' }}</code></pre>
            
            <p><strong>Finding Related Data (e.g., Backups for an Agent):</strong></p>
            <pre><code>{{ '{% for agent in agents %}' }}
  {{ '<h3>{{ agent.display_name or agent.hostname }}</h3>' }}
  {{ '<h4>Recent Backups:</h4>' }}
  {{ '{% for backup in backups %}' }}
    {{ '{% if backup.agent_id == agent.agent_id %}' }}
      {{ '<p>{{ backup.started_at }}: {{ backup.status }}</p>' }}
    {{ '{% endif %}' }}
  {{ '{% endfor %}' }}
{{ '{% endfor %}' }}</code></pre>
            
            <p><strong>Counting Items:</strong></p>
            <pre><code>{{ '<p>Total Devices: {{ devices|length }}</p>' }}
{{ '<p>Total Agents: {{ agents|length }}</p>' }}
{{ '<p>Backups in Period: {{ backups|length }}</p>' }}</code></pre>
        </div>
    </div>

    <!-- Jinja2 Filters & Functions -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-funnel"></i> Jinja2 Filters & Functions</h3>
        </div>
        <div class="card-body">
            <p>Jinja2 provides powerful filters and operations for template expressions:</p>
            
            <h5 class="mt-4">Common Filters</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 30%;">Filter</th>
                        <th style="width: 70%;">Usage Example</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>|length</code></td>
                        <td><code>{{ '{{ items|length }}' }}</code> - Get length of list or string</td>
                    </tr>
                    <tr>
                        <td><code>|default</code></td>
                        <td><code>{{ '{{ variable|default("N/A") }}' }}</code> - Provide default if None/missing</td>
                    </tr>
                    <tr>
                        <td><code>|round</code></td>
                        <td><code>{{ '{{ 3.14159|round(2) }}' }}</code> - Round to 2 decimal places (outputs 3.14)</td>
                    </tr>
                    <tr>
                        <td><code>|upper</code></td>
                        <td><code>{{ '{{ name|upper }}' }}</code> - Convert to uppercase</td>
                    </tr>
                    <tr>
                        <td><code>|lower</code></td>
                        <td><code>{{ '{{ name|lower }}' }}</code> - Convert to lowercase</td>
                    </tr>
                    <tr>
                        <td><code>|title</code></td>
                        <td><code>{{ '{{ name|title }}' }}</code> - Title case (capitalize each word)</td>
                    </tr>
                    <tr>
                        <td><code>|join</code></td>
                        <td><code>{{ '{{ items|join(", ") }}' }}</code> - Join list with separator</td>
                    </tr>
                    <tr>
                        <td><code>|replace</code></td>
                        <td><code>{{ '{{ text|replace("old", "new") }}' }}</code> - Replace substring</td>
                    </tr>
                </tbody>
            </table>
            
            <h5 class="mt-4">Math Operations</h5>
            <p>You can use standard math operators in expressions:</p>
            <pre><code>{{ '{{ (storage_bytes / 1024**3)|round(2) }}' }} GB   {# Division and exponent #}
{{ '{{ count + 5 }}' }}                         {# Addition #}
{{ '{{ total - failed }}' }}                    {# Subtraction #}
{{ '{{ rate * 100 }}' }}                        {# Multiplication #}
{{ '{{ value // 2 }}' }}                        {# Integer division #}
{{ '{{ value % 10 }}' }}                        {# Modulo #}</code></pre>
            
            <h5 class="mt-4">List Slicing</h5>
            <p>Use Python-style slicing to limit lists:</p>
            <pre><code>{{ '{% for item in items[:10] %}' }}     {# First 10 items #}
{{ '{% for item in items[5:] %}' }}      {# All items starting from index 5 #}
{{ '{% for item in items[::2] %}' }}     {# Every other item #}</code></pre>
            
            <h5 class="mt-4">Conditional Operations</h5>
            <p>Use comparisons and logic operators:</p>
            <pre><code>{{ '{% if count > 10 %}' }}              {# Comparison operators: >, <, >=, <=, ==, != #}
{{ '{% if a and b %}' }}                 {# Logical operators: and, or, not #}
{{ '{% if item in list %}' }}            {# Membership test #}
{{ '{{ "yes" if condition else "no" }}' }} {# Inline if/else (ternary) #}
{{ '{{ variable or "default" }}' }}      {# Default value with 'or' #}</code></pre>
            
            <h5 class="mt-4">String Concatenation</h5>
            <p>Use the <code>~</code> operator to concatenate strings:</p>
            <pre><code>{{ '{{ first_name ~ " " ~ last_name }}' }}
{{ '{{ device.hostname ~ " (" ~ device.os ~ ")" }}' }}</code></pre>
            
            <div class="alert alert-info mt-4">
                <strong>💡 Tip:</strong> Always check for None/null values before using operations:
                <pre class="mb-0"><code>{{ '{% if device.storage_used_bytes %}' }}
  {{ '{{ (device.storage_used_bytes / 1024**3)|round(1) }} GB' }}
{{ '{% else %}' }}
  N/A
{{ '{% endif %}' }}</code></pre>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header">
            <h3 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h3>
        </div>
        <div class="card-body">
            <a href="{{ url_for('templates_list') }}" class="btn btn-primary">
                <i class="bi bi-layout-text-window-reverse"></i> View Templates
            </a>
            <a href="{{ url_for('templates_new') }}" class="btn btn-success">
                <i class="bi bi-magic"></i> Create New Template
            </a>
        </div>
    </div>
</div>

<script>
async function downloadJSONSchema() {
    try {
        const response = await fetch('/api/template-schema.json');
        if (!response.ok) {
            throw new Error('Failed to fetch schema');
        }
        
        const schema = await response.json();
        const schemaStr = JSON.stringify(schema, null, 2);
        const blob = new Blob([schemaStr], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'slide-report-template-schema.json';
        document.body.appendChild(a);
        a.click();
        
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        window.slideReports.utils.showToast('Schema downloaded successfully', 'success');
    } catch (error) {
        console.error('Download error:', error);
        alert('Failed to download schema: ' + error.message);
    }
}
</script>
{% endblock %}

