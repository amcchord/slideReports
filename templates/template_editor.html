{% extends "base.html" %}

{% block title %}{% if template %}Edit{% else %}New{% endif %} Template - Slide Reports{% endblock %}

{% block extra_head %}
<!-- Monaco Editor will be loaded via script tag with onload handler -->
{% endblock %}

{% block content %}
<div style="margin-top: 2rem;">
    {% if template and template.is_builtin %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> This is a built-in recipe template and cannot be edited. 
        You can create a copy to customize it.
    </div>
    {% endif %}
    
    <h1>{% if template and template.is_builtin %}View{% elif template %}Edit{% else %}Create New{% endif %} Template</h1>
    
    <div class="card mb-4">
        <div class="card-body">
            <form id="template-form">
                <div class="mb-3">
                    <label for="template-name" class="form-label">Template Name</label>
                    <input type="text" class="form-control" id="template-name" 
                           value="{% if template %}{{ template.name }}{% endif %}" 
                           {% if template and template.is_builtin %}readonly{% endif %} required>
                </div>
                
                <div class="mb-3">
                    <label for="template-description" class="form-label">Description</label>
                    <textarea class="form-control" id="template-description" rows="2">{% if template %}{{ template.description }}{% endif %}</textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Data Sources to Include</label>
                    <div class="data-sources-grid">
                        {% set icon_map = {
                            'devices': 'bi-hdd',
                            'agents': 'bi-cpu',
                            'backups': 'bi-arrow-repeat',
                            'snapshots': 'bi-camera',
                            'alerts': 'bi-exclamation-triangle',
                            'audits': 'bi-file-earmark-text',
                            'clients': 'bi-building',
                            'users': 'bi-people',
                            'networks': 'bi-diagram-3',
                            'virtual_machines': 'bi-box',
                            'file_restores': 'bi-folder-symlink',
                            'image_exports': 'bi-file-earmark-image',
                            'accounts': 'bi-person-badge'
                        } %}
                        {% for source in data_sources %}
                        <label class="source-toggle-card" for="source-{{ source.key }}">
                            <div class="source-icon">
                                <i class="bi {{ icon_map.get(source.key, 'bi-box') }}"></i>
                            </div>
                            <div class="source-info">
                                <div class="source-name">{{ source.name }}</div>
                                <div class="source-count">{{ source.count }} items</div>
                            </div>
                            <div class="custom-toggle-switch">
                                <input type="checkbox" value="{{ source.key }}" id="source-{{ source.key }}" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div class="template-editor">
        <div class="editor-panel">
            <!-- Tabs for Generation vs Refinement -->
            <ul class="nav nav-tabs mb-3" id="ai-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="generate-tab" data-bs-toggle="tab" data-bs-target="#generate-panel" type="button" role="tab">
                        <i class="bi bi-magic"></i> Generate New
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="refine-tab" data-bs-toggle="tab" data-bs-target="#refine-panel" type="button" role="tab">
                        <i class="bi bi-brush"></i> Refine Existing
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="ai-tab-content">
                <!-- Generate Tab -->
                <div class="tab-pane fade" id="generate-panel" role="tabpanel">
                    <h3>AI Template Generation</h3>
                    <p class="text-muted small">
                        Describe how you want your report to look. Be specific about sections, colors, and layout.
                    </p>
                    
                    <textarea class="form-control mb-3" id="template-prompt" rows="6" 
                              placeholder="Example: Create a professional backup report with a blue header, metric cards showing backup success rates, and a table of recent backups...">{% if template %}{{ template.description }}{% else %}{{ default_description }}{% endif %}</textarea>
                    
                    <div class="alert alert-info mb-3" style="font-size: 0.875rem;">
                        <i class="bi bi-info-circle"></i> <strong>Note:</strong> AI template generation streams in real-time (1-3 minutes typical).
                    </div>
                    
                    <button class="btn btn-primary w-100" id="generate-button" onclick="generateTemplate()">
                        <i class="bi bi-magic"></i> Generate Template with AI
                    </button>
                    
                    <!-- Streaming progress -->
                    <div id="generation-progress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                        </div>
                        <small class="text-muted">Streaming template HTML...</small>
                    </div>
                </div>
                
                <!-- Refine Tab -->
                <div class="tab-pane fade show active" id="refine-panel" role="tabpanel">
                    <h3>AI Template Refinement</h3>
                    <p class="text-muted small">
                        Describe how you want to improve the current template (e.g., "Make the header blue", "Add a chart for backup trends").
                    </p>
                    
                    <textarea class="form-control mb-3" id="improve-prompt" rows="5" 
                              placeholder="Example: Make the colors more professional, add a summary section at the top..."></textarea>
                    
                    <button class="btn btn-primary w-100 mb-3" id="improve-button" onclick="improveTemplate()" {% if template and template.is_builtin %}disabled{% endif %}>
                        <i class="bi bi-magic"></i> Improve Template with AI
                    </button>
                </div>
            </div>
            
            <hr class="my-4">
            
            <h3>Test with Real Data</h3>
            <p class="text-muted small">
                Test your template with actual data from your account to see how it will look in production.
            </p>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="test-start-date" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="test-start-date">
                </div>
                <div class="col-md-6">
                    <label for="test-end-date" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="test-end-date">
                </div>
            </div>
            
            <button class="btn btn-success w-100 mb-3" id="test-button" onclick="testWithRealData()">
                <i class="bi bi-play-circle"></i> Test with Real Data
            </button>
            
            <hr class="my-4">
            
            <h3>HTML Editor</h3>
            <p class="text-muted small">
                You can paste complete HTML templates here or edit the AI-generated HTML directly.
                <a href="{{ url_for('report_values_docs') }}" target="_blank">
                    <i class="bi bi-book"></i> View all available template variables
                </a>
            </p>
            <div id="template-html-editor"></div>
            <textarea class="form-control" id="template-html" rows="12" style="display: none;" 
                      placeholder="Paste your HTML here or use AI generation above...">{% if template %}{{ template.html_content }}{% endif %}</textarea>
        </div>
        
        <div class="editor-panel">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h3 class="mb-0">Preview</h3>
                <span class="badge bg-secondary" id="preview-mode-badge">Basic Preview</span>
            </div>
            <p class="text-muted small" id="preview-description">
                This shows how your template will look with sample data.
            </p>
            
            <!-- Error display area -->
            <div id="error-display" class="alert alert-danger" style="display: none;">
                <h5><i class="bi bi-exclamation-triangle"></i> Template Error</h5>
                <pre id="error-message" class="mb-3" style="white-space: pre-wrap; font-size: 0.875rem;"></pre>
                <button class="btn btn-warning btn-sm" id="auto-fix-button" onclick="autoFixError()">
                    <i class="bi bi-magic"></i> Auto-fix with AI
                </button>
            </div>
            
            <iframe id="template-preview" class="preview-frame"></iframe>
        </div>
    </div>
    
    <div class="mt-4 d-flex gap-2">
        {% if template and template.is_builtin %}
        <button class="btn btn-primary" onclick="cloneAndEdit()">
            <i class="bi bi-files"></i> Clone & Edit
        </button>
        {% else %}
        <button class="btn btn-success" onclick="saveTemplate()">
            <i class="bi bi-save"></i> Save Template
        </button>
        {% endif %}
        <a href="{{ url_for('templates_list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i> Cancel
        </a>
    </div>
</div>

<script>
let templateId = {% if template %}{{ template.template_id }}{% else %}null{% endif %};
let monacoEditor = null;

// Initialize Monaco Editor by dynamically loading the loader script
function initMonacoEditor() {
    console.log('Starting Monaco Editor initialization...');
    
    const initialValue = document.getElementById('template-html').value || '';
    const isReadOnly = {% if template and template.is_builtin %}true{% else %}false{% endif %};
    const editorContainer = document.getElementById('template-html-editor');
    
    if (!editorContainer) {
        console.error('Monaco editor container not found');
        document.getElementById('template-html').style.display = 'block';
        return;
    }
    
    // Load Monaco loader script dynamically
    const loaderScript = document.createElement('script');
    loaderScript.src = 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js';
    loaderScript.async = true;
    
    loaderScript.onload = function() {
        console.log('Monaco loader loaded successfully');
        
        // Now require is available
        if (typeof require === 'undefined') {
            console.error('require still not defined after loading loader.js');
            document.getElementById('template-html').style.display = 'block';
            return;
        }
        
        require.config({ 
            paths: { 
                vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' 
            }
        });
        
        require(['vs/editor/editor.main'], function() {
            try {
                monacoEditor = monaco.editor.create(editorContainer, {
                    value: initialValue,
                    language: 'html',
                    theme: 'vs',
                    automaticLayout: true,
                    minimap: { enabled: true },
                    readOnly: isReadOnly,
                    wordWrap: 'on',
                    fontSize: 14,
                    lineNumbers: 'on',
                    scrollBeyondLastLine: false,
                    formatOnPaste: true,
                    formatOnType: true
                });
                
                console.log('Monaco Editor initialized successfully', {
                    hasInitialValue: !!initialValue,
                    valueLength: initialValue.length
                });
                
                // Sync Monaco editor changes to hidden textarea
                monacoEditor.onDidChangeModelContent(function() {
                    const value = monacoEditor.getValue();
                    document.getElementById('template-html').value = value;
                    
                    // Update preview
                    updatePreview(value);
                });
                
                // Initial preview
                if (initialValue) {
                    updatePreview(initialValue);
                }
                
                // Make Monaco globally accessible for other scripts
                window.monacoEditor = monacoEditor;
                window.monacoEditorInstance = monacoEditor;
                
            } catch (error) {
                console.error('Failed to initialize Monaco Editor:', error);
                // Fallback: show the textarea
                document.getElementById('template-html').style.display = 'block';
            }
        }, function(err) {
            console.error('Failed to load Monaco Editor modules:', err);
            // Fallback: show the textarea
            document.getElementById('template-html').style.display = 'block';
        });
    };
    
    loaderScript.onerror = function() {
        console.error('Failed to load Monaco loader script');
        // Fallback: show the textarea
        document.getElementById('template-html').style.display = 'block';
    };
    
    document.head.appendChild(loaderScript);
}

// Wait for DOM to be ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMonacoEditor);
} else {
    // DOM already loaded
    initMonacoEditor();
}

function updatePreview(htmlContent) {
    const previewFrame = document.getElementById('template-preview');
    if (previewFrame) {
        const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
        previewDoc.open();
        previewDoc.write(htmlContent);
        previewDoc.close();
    }
}

function getSelectedDataSources() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

async function cloneAndEdit() {
    if (!templateId) {
        alert('No template to clone');
        return;
    }
    
    try {
        const response = await fetch(`/api/templates/${templateId}/clone`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const data = await response.json();
            window.slideReports.utils.showToast(`Template cloned as "${data.name}"`, 'success');
            setTimeout(() => {
                window.location.href = `/templates/${data.template_id}`;
            }, 1000);
        } else {
            const data = await response.json();
            alert('Failed to clone template: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error cloning template: ' + error.message);
    }
}

async function generateTemplate() {
    const description = document.getElementById('template-prompt').value;
    const dataSources = getSelectedDataSources();
    
    if (!description.trim()) {
        alert('Please enter a description');
        return;
    }
    
    await window.slideReports.templateManager.generateTemplate(description, dataSources);
}

async function saveTemplate() {
    const name = document.getElementById('template-name').value;
    const description = document.getElementById('template-description').value;
    
    // Get HTML content from Monaco editor if available, otherwise from textarea
    let htmlContent;
    if (monacoEditor) {
        htmlContent = monacoEditor.getValue();
    } else {
        htmlContent = document.getElementById('template-html').value;
    }
    
    if (!name.trim()) {
        alert('Please enter a template name');
        return;
    }
    
    if (!htmlContent.trim()) {
        alert('Please generate or enter HTML content');
        return;
    }
    
    if (templateId) {
        // Update existing template
        try {
            const response = await fetch(`/api/templates/${templateId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    description: description,
                    html_content: htmlContent
                })
            });
            
            if (response.ok) {
                window.slideReports.utils.showToast('Template updated successfully', 'success');
                setTimeout(() => window.location.href = '/templates', 1000);
            } else {
                throw new Error('Update failed');
            }
        } catch (error) {
            alert('Failed to update template: ' + error.message);
        }
    } else {
        // Create new template
        await window.slideReports.templateManager.saveTemplate(name, description, htmlContent);
    }
}

// Global variable to store last error for auto-fix
let lastTestError = null;

async function improveTemplate() {
    const improvementRequest = document.getElementById('improve-prompt').value;
    
    if (!improvementRequest.trim()) {
        alert('Please describe how you want to improve the template');
        return;
    }
    
    // Get current HTML
    let currentHtml;
    if (monacoEditor) {
        currentHtml = monacoEditor.getValue();
    } else {
        currentHtml = document.getElementById('template-html').value;
    }
    
    if (!currentHtml.trim()) {
        alert('No template to improve. Generate a template first.');
        return;
    }
    
    await window.slideReports.templateManager.improveTemplate(improvementRequest, currentHtml);
}

async function testWithRealData() {
    const startDate = document.getElementById('test-start-date').value;
    const endDate = document.getElementById('test-end-date').value;
    
    if (!startDate || !endDate) {
        alert('Please select start and end dates');
        return;
    }
    
    // Get HTML content
    let htmlContent;
    if (monacoEditor) {
        htmlContent = monacoEditor.getValue();
    } else {
        htmlContent = document.getElementById('template-html').value;
    }
    
    if (!htmlContent.trim()) {
        alert('No template to test. Generate a template first.');
        return;
    }
    
    const dataSources = getSelectedDataSources();
    
    await window.slideReports.templateManager.testWithRealData(
        htmlContent, 
        startDate, 
        endDate, 
        dataSources, 
        null  // client_id
    );
}

async function autoFixError() {
    if (!lastTestError) {
        alert('No error to fix');
        return;
    }
    
    // Get current HTML
    let htmlContent;
    if (monacoEditor) {
        htmlContent = monacoEditor.getValue();
    } else {
        htmlContent = document.getElementById('template-html').value;
    }
    
    await window.slideReports.templateManager.fixTemplateError(htmlContent, lastTestError);
}

// Initialize date pickers with default values (last 7 days)
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(today.getDate() - 7);
    
    // Format dates as YYYY-MM-DD
    const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    document.getElementById('test-start-date').value = formatDate(sevenDaysAgo);
    document.getElementById('test-end-date').value = formatDate(today);
    
    // Auto-switch to Generate tab if no HTML content exists
    const htmlField = document.getElementById('template-html');
    const generateTab = document.getElementById('generate-tab');
    const refineTab = document.getElementById('refine-tab');
    
    if (htmlField && (!htmlField.value || htmlField.value.trim() === '')) {
        // No HTML content - show Generate tab
        if (generateTab) {
            const tabTrigger = new bootstrap.Tab(generateTab);
            tabTrigger.show();
        }
    }
    // Otherwise, Refine tab is already active by default
});
</script>
{% endblock %}

